<!DOCTYPE html>
<html lang="fr">
    <head>
        <link rel="stylesheet" href="/app" type="text/css">
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
        <script src="http://ajax.microsoft.com/ajax/jquery.templates/beta1/jquery.tmpl.min.js"></script>
        <script src="/socket.io/socket.io.js"></script>
    </head>

    <body>
        <div id="login">
          <h1 class="center">Datalk</h1>
            <form id="connect-form">
              <label for="username">Username : </label>
              <input type="text" id="username" name="username">
              <button type="submit" id="connect">Connect</button>
            </form>
            <div id="auth-fail">Please, enter a nickname.</div>
        </div>

        <div id="chat">
            <ul id="messages"></ul>
            <div id="users">
              Number of users : <span id="users-count">0</span>
              <ul id="users-list">
              </ul>
            </div>
            <form id="message-form">
              <input id="message-input" />
            </form>
        </div>

        <script id="datalkMessageTmpl" type="text/x-jquery-tmpl">
            <li class="datalk-message"><strong>${author}</strong> : ${message}</li>
        </script>

        <script id="datalkUserTmpl" type="text/x-jquery-tmpl">
            <li id="user-${nickname}">${nickname}</li>
        </script>

        <script id="systemMessageTmpl" type="text/x-jquery-tmpl">
            <li class="system-message">${message}</li>
        </script>

        <script>
          $(document).ready(function(){
            var socket = io.connect('http://localhost');
             $('#username').focus();

             $('#connect').click(function(e) {
                e.preventDefault();
                var nickname = $("#username").val();

                if(nickname) {
                  socket.emit('login', nickname, function(success, messages, users) {

                    //View
                    $('#login').hide();
                    $('#chat').show();
                    $('#users-count').html(users.length);

                    $.each(messages, function(i, msg) { $('#datalkMessageTmpl').tmpl({author: msg.author, message: msg.content}).appendTo("#messages")});
                    $.each(users, function(i, nick) { $('#datalkUserTmpl').tmpl({nickname: nick}).appendTo("#users-list") });

                    $('#message-input').focus();

                    //Send message
                    $('#message-form').submit(function(e) {
                      e.preventDefault();
                      var message = $("#message-input").val();

                      if(message)
                      {
                        socket.emit('send-message', {author: nickname, content: message});
                        $("#message-input").val("");
                      }
                    });

                    //New message to display
                    socket.on('new-message', function(message) {
                      $('#datalkMessageTmpl').tmpl({author: message.author, message: message.content}).appendTo("#messages");

                      $("#messages").scrollTop($("#messages").prop("scrollHeight") - $("#messages").height());
                    });

                    //New user logged in
                    socket.on("new-user", function(nickname, users) {
                      $("#users-count").html(users.length);
                      $('#users-list').append('<li>'+ nickname +'</li>');
                      var message = nickname + " joined.";
                    });

                    socket.on("user-logged-out", function(nickname, usersCount) {
                      $("#users-count").html(usersCount);
                      $("#user-" + nickname).remove();
                      var message = nickname + " has left the channel.";
                      $("#systemMessageTmpl").tmpl({message: message}).appendTo("#messages");
                      $("#messages").scrollTop($("#messages").prop("scrollHeight") - $("#messages").height());
                    });

                  });
                } 
                else 
                {
                  $('#auth-fail').show();
                }
            }); 
          });
        </script>
    </body>
</html>
