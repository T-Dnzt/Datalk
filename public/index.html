<!DOCTYPE html>
<html lang="fr">
    <head>
        <link rel="stylesheet" href="css/app.css" type="text/css">
        <link rel="stylesheet" href="http://code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css" />
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
        <script src="http://ajax.microsoft.com/ajax/jquery.templates/beta1/jquery.tmpl.min.js"></script>
        <script src="http://code.jquery.com/ui/1.9.2/jquery-ui.js"></script>
        <script src="/socket.io/socket.io.js"></script>
    </head>

    <body>
        <div id="login">
          <h1 class="center">Datalk</h1>
            <form id="connect-form">
              <label for="username">Username : </label>
              <input type="text" id="username" name="username">
              <button type="submit" id="connect">Connect</button>
            </form>
            <div id="existing-nickname">This nickname is already in use. Please pick an other.</div>
            <div id="auth-fail">Please, enter a nickname.</div>
        </div>

        <div id="talks">
          <h2>Last talks : </h2>
          <ul id="talks-list"></ul>
        </div>

        <div id="tabs">
          <ul id="tabs-list">
 
          </ul>

        </div>

        <script id="datalkTabsListTmpl" type="text/x-jquery-tmpl">
          <li><a href="#${chan}">#${chan}</a></li>
        </script>

        <script id="datalkChatTmpl" type="text/x-jquery-tmpl">
          <div id="${chan}" style="height:80%;">
              <ul class="messages"></ul>
              <div class="users">
                <h3 class="chatname"></h3>
                Number of users : <span class="users-count">0</span>
                <ul class="users-list">
                </ul>
              </div>
              <div class="channels">
                <h3>Available channels :</h3>
                <span class="chat-commands">Commands : /join /quit with chan name.</span>
                <ul class="channels-list">  
                </ul>
              </div>
              <form class="message-form">
                <input class="message-input" />
              </form>
          </div>
        </script>

        <script id="datalkMessageTmpl" type="text/x-jquery-tmpl">
            <li class="datalk-message"><strong>${author}</strong> : ${message}</li>
        </script>

        <script id="datalkLiTmpl" type="text/x-jquery-tmpl">
            <li class="li-${name}">${name}</li>
        </script>

        <script id="systemMessageTmpl" type="text/x-jquery-tmpl">
            <li class="system-message">${message}</li>
        </script>

        <script id="talkTmpl" type="text/x-jquery-tmpl">
            <li class="talk-${id}"><a href="/talk/${permalink}">${title}</a></li>
        </script>

         <script id="newTalkMessageTmpl" type="text/x-jquery-tmpl">
            <li class="datalk-message">
              A new talk has been created about this topic. You can find it here : 
              <a href="/talk/${permalink}">${permalink}</a>
            </li>
        </script>

        <script>
          $(document).ready(function(){
            $( "#tabs" ).tabs();

            var socket = io.connect('http://localhost');
             $('#username').focus();

             socket.emit('gettalks', function(success, talks) {
              if(success) {
                $.each(talks, function(i, talk) { 
                  $('#talkTmpl').tmpl({id: talk._id, permalink: talk.permalink, title: talk.permalink}).appendTo("#talks-list");
                });
              }
             });

            var displayChannels = function(channels) {
              var channelLists = $('.channels-list');
              channelLists.html("");
              $.each(channels, function(i, channel) {
                $('#datalkLiTmpl').tmpl({name: channel}).appendTo(channelLists)
              });
            }    


             $('#connect').click(function(e) {
                e.preventDefault();
                var nickname = $("#username").val();

                
                if(nickname) {

                  var createChannel = function(messages, users, chatname, channels) {

                      $('#datalkChatTmpl').tmpl({chan : chatname}).appendTo('#tabs');
                      $('#tabs').tabs('add', "#"+chatname, "#"+chatname);
                      $( "#tabs" ).tabs( 'select', $( "#tabs" ).tabs('length') - 1);

                      var chatDiv = $('#'+chatname);
                      chatDiv.find('.chatname').html("Channel #" + chatname);
                      chatDiv.find('.users-count').html(users.length);

                      $.each(messages, function(i, msg) { $('#datalkMessageTmpl').tmpl({author: msg.author, message: msg.content}).appendTo(chatDiv.find('.messages'))});

                      $.each(users, function(i, nick) { 
                        $('#datalkLiTmpl').tmpl({name: nick}).appendTo(chatDiv.find(' .users-list')) });

                      displayChannels(channels);


                      chatDiv.find('.message-input').focus();

                      chatDiv.find('.message-form').submit(function(e) {
                        e.preventDefault();
                        var message = chatDiv.find('.message-input').val();
                        if(message)
                        {
                          socket.emit('send-message', {author: nickname, content: message}, chatname);
                          chatDiv.find('.message-input').val("");
                        }
                      });
                    }



                  socket.emit('login', nickname, function(success, messages, users, chatname, channels) {

                    if(success) {

                        $('#login').hide();
                        $('#talks').hide();
                        $('#tabs').show();

                        createChannel(messages, users, chatname, channels);

                        socket.on("join-channel", function(messages, users, chatname, channels) {
                          createChannel(messages, users, chatname, channels);
                        });

                        socket.on("left-channel", function(chatname) {
                          $('#tabs').tabs('remove', "#"+chatname, "#"+chatname);
                          $('#tabs').remove("#"+chatname);
                        });

                          //New message to display
                          socket.on('new-message', function(message, chatname) {
                            $('#datalkMessageTmpl').tmpl({author: message.author, message: message.content}).appendTo('#'+chatname+' .messages');

                            $('#'+chatname+' .messages').scrollTop($('#'+chatname+' .messages').prop("scrollHeight") - $('#'+chatname+' .messages').height());
                          });

                          socket.on('new-talk', function(permalink, chatname) {
                            $('#newTalkMessageTmpl').tmpl({permalink: permalink}).appendTo('#'+chatname+' .messages');             
                          });

                          //New user logged in
                          socket.on("new-user", function(nickname, users, chatname) {
                            $('#'+chatname+' .users-count').html(users.length);
                            $('#datalkLiTmpl').tmpl({name: nickname}).appendTo('#'+chatname+' .users-list');
                            $('#'+chatname+' .messages').append("<li>"+ nickname + " joined.</li>");
                          });

                          socket.on("new-chan", function(channels) {
                            displayChannels(channels);
                            //$('#datalkLiTmpl').tmpl({name: channel}).appendTo(' .channels-list');
                          });

                          socket.on("delete-chan", function(channels) {
                            displayChannels(channels);
                          });

                          socket.on("user-left-chan", function(nickname, usersCount, chatname) {
                            $('#'+chatname+' .users-count').html(usersCount);
                            $('#'+chatname+' .li-' + nickname).remove();
                            var message = nickname + " has left the channel.";
                            $("#systemMessageTmpl").tmpl({message: message}).appendTo('#'+chatname+' .messages');
                            $('#'+chatname+' .messages').scrollTop($('#'+chatname+' .messages').prop("scrollHeight") - $('#'+chatname+' .messages').height());
                          });


                    } else {
                      $('#existing-nickname').show();
                    }
                  });
                } else {
                  $('#auth-fail').show();
                }
            });
          });
        </script>
    </body>
</html>
